{"version":3,"file":"export.js","sources":["../../../../src/client/modules/encrypt/components/PasswordModal.ts","../../../../src/client/modules/encrypt/composables/useEncryptData.ts","../../../../src/client/modules/encrypt/composables/useGlobalEncrypt.ts","../../../../src/client/modules/encrypt/utils/isTokenMatched.ts","../../../../src/client/modules/encrypt/composables/usePathEncrypt.ts","../../../../src/client/modules/encrypt/components/GlobalEncrypt.ts","../../../../src/client/modules/encrypt/components/LocalEncrypt.ts"],"sourcesContent":["import type { VNode } from \"vue\";\nimport { computed, defineComponent, h, nextTick, ref } from \"vue\";\nimport { usePageFrontmatter } from \"vuepress/client\";\n\nimport { useThemeLocaleData } from \"@theme-hope/composables/index\";\n\nimport { LockIcon } from \"./icons.js\";\n\nimport \"../styles/password-modal.scss\";\n\nexport default defineComponent({\n  name: \"PasswordModal\",\n\n  props: {\n    /**\n     * Whether is fullscreen\n     *\n     * 是否是全屏\n     */\n    full: Boolean,\n  },\n\n  emits: [\"verify\"],\n\n  setup(props, { emit }) {\n    const frontmatter = usePageFrontmatter();\n    const themeLocale = useThemeLocaleData();\n    const password = ref(\"\");\n    const hasTried = ref(false);\n    const remember = ref(false);\n\n    const locale = computed(() => themeLocale.value.encryptLocales);\n\n    let hintHandler: number | null = null;\n\n    const verify = (): void => {\n      // Clear previous handler\n      if (hintHandler) clearTimeout(hintHandler);\n      hasTried.value = false;\n\n      emit(\"verify\", password.value, remember.value);\n\n      void nextTick().then(() => {\n        hasTried.value = true;\n\n        hintHandler = setTimeout(() => {\n          hasTried.value = false;\n        }, 1000) as unknown as number;\n      });\n    };\n\n    return (): VNode =>\n      h(\n        \"div\",\n        {\n          class: [\n            \"vp-decrypt-layer\",\n            { expand: props.full || frontmatter.value[\"home\"] },\n          ],\n        },\n        h(\"div\", { class: \"vp-decrypt-modal\" }, [\n          h(\n            \"div\",\n            { class: [\"vp-decrypt-hint\", { tried: hasTried.value }] },\n            hasTried.value\n              ? locale.value.errorHint\n              : h(LockIcon, { \"aria-label\": locale.value.iconLabel }),\n          ),\n          h(\"div\", { class: \"vp-decrypt-input\" }, [\n            h(\"input\", {\n              type: \"password\",\n              value: password.value,\n              placeholder: locale.value.placeholder,\n              onInput: ({ target }: InputEvent) => {\n                password.value = (target as HTMLInputElement).value;\n              },\n              onKeydown: ({ key }: KeyboardEvent) => {\n                if (key === \"Enter\") verify();\n              },\n            }),\n          ]),\n          h(\"div\", { class: \"vp-remember-password\" }, [\n            h(\"input\", {\n              type: \"checkbox\",\n              value: remember.value,\n              onChange: () => (remember.value = !remember.value),\n            }),\n            locale.value.remember,\n          ]),\n          h(\n            \"button\",\n            {\n              type: \"button\",\n              class: \"vp-decrypt-submit\",\n              onClick: () => verify(),\n            },\n            \"OK\",\n          ),\n        ]),\n      );\n  },\n});\n","import type { ComputedRef } from \"vue\";\nimport { computed } from \"vue\";\n\nimport { useThemeData } from \"@theme-hope/composables/index\";\n\nimport type { EncryptConfig } from \"../../../../shared/index.js\";\n\nexport const useEncryptData = (): ComputedRef<EncryptConfig> => {\n  const themeData = useThemeData();\n\n  return computed(() => themeData.value.encrypt || {});\n};\n","import { useSessionStorage, useStorage } from \"@vueuse/core\";\nimport { compareSync } from \"bcrypt-ts/browser\";\nimport type { ComputedRef } from \"vue\";\nimport { computed } from \"vue\";\n\nimport { useEncryptData } from \"./useEncryptData.js\";\n\nconst STORAGE_KEY = \"VUEPRESS_HOPE_GLOBAL_TOKEN\";\n\nexport interface GlobalEncrypt {\n  isEncrypted: ComputedRef<boolean>;\n  isDecrypted: ComputedRef<boolean>;\n  validate: (token: string, keep?: boolean) => void;\n}\n\nexport const useGlobalEncrypt = (): GlobalEncrypt => {\n  const encryptData = useEncryptData();\n\n  const localToken = useStorage(STORAGE_KEY, \"\");\n  const sessionToken = useSessionStorage(STORAGE_KEY, \"\");\n\n  // Is globally encrypted\n  const isEncrypted = computed(() => {\n    const { global = false, admin = [] } = encryptData.value;\n\n    return global && admin.length > 0;\n  });\n\n  // Valid token exists\n  const isDecrypted = computed(() => {\n    if (isEncrypted.value) {\n      if (localToken.value)\n        // None of the token matches\n        return encryptData.value.admin!.some((hash) =>\n          compareSync(localToken.value, hash),\n        );\n\n      if (sessionToken.value)\n        // None of the token matches\n        return encryptData.value.admin!.some((hash) =>\n          compareSync(sessionToken.value, hash),\n        );\n    }\n\n    return false;\n  });\n\n  const validate = (inputToken: string, keep = false): void => {\n    (keep ? localToken : sessionToken).value = inputToken;\n  };\n\n  return {\n    isEncrypted,\n    isDecrypted,\n    validate,\n  };\n};\n","import { compareSync } from \"bcrypt-ts/browser\";\n\nexport const isTokenMatched = (token = \"\", hash: string): boolean =>\n  Boolean(token) && compareSync(token, hash);\n","import { isPlainObject, keys, startsWith } from \"@vuepress/helper/client\";\nimport { useSessionStorage, useStorage } from \"@vueuse/core\";\nimport type { ComputedRef } from \"vue\";\nimport { computed } from \"vue\";\nimport { usePageData } from \"vuepress/client\";\n\nimport { isTokenMatched } from \"@theme-hope/modules/encrypt/utils/index\";\n\nimport { useEncryptData } from \"./useEncryptData.js\";\n\nconst STORAGE_KEY = \"VUEPRESS_HOPE_PATH_TOKEN\";\n\nexport interface EncryptStatus {\n  isEncrypted: boolean;\n  isDecrypted: boolean;\n}\n\nexport interface PathEncrypt {\n  status: ComputedRef<EncryptStatus>;\n  getStatus: (path: string) => EncryptStatus;\n  validate: (token: string, keep?: boolean) => void;\n}\n\nexport const usePathEncrypt = (): PathEncrypt => {\n  const page = usePageData();\n  const encryptData = useEncryptData();\n\n  const localToken = useStorage<Record<string, string>>(STORAGE_KEY, {});\n  const sessionToken = useSessionStorage<Record<string, string>>(\n    STORAGE_KEY,\n    {},\n  );\n\n  const getPathMatchedKeys = (path: string): string[] =>\n    isPlainObject(encryptData.value.config)\n      ? keys(encryptData.value.config)\n          .filter((key) => startsWith(decodeURI(path), key))\n          .sort((a, b) => b.length - a.length)\n      : [];\n\n  const getStatus = (path: string): EncryptStatus => {\n    const matchedKeys = getPathMatchedKeys(path);\n\n    if (matchedKeys.length > 0) {\n      const { config = {} } = encryptData.value;\n\n      return {\n        isEncrypted: true,\n        isDecrypted: matchedKeys.some(\n          (key) =>\n            (localToken.value[key] &&\n              config[key].some((token) =>\n                isTokenMatched(localToken.value[key], token),\n              )) ||\n            (sessionToken.value[key] &&\n              config[key].some((token) =>\n                isTokenMatched(sessionToken.value[key], token),\n              )),\n        ),\n      };\n    }\n\n    return {\n      isDecrypted: false,\n      isEncrypted: false,\n    };\n  };\n\n  const status = computed(() => getStatus(page.value.path));\n\n  const validate = (inputToken: string, keep = false): void => {\n    const { config = {} } = encryptData.value;\n    const matchedKeys = getPathMatchedKeys(page.value.path);\n\n    // Some of the tokens matches\n    for (const hitKey of matchedKeys)\n      if (config[hitKey].filter((token) => isTokenMatched(inputToken, token))) {\n        (keep ? localToken : sessionToken).value[hitKey] = inputToken;\n\n        break;\n      }\n  };\n\n  return {\n    status,\n    getStatus,\n    validate,\n  };\n};\n","import type { SlotsType, VNode } from \"vue\";\nimport { defineComponent, h, onMounted, ref } from \"vue\";\n\nimport { FadeSlideY } from \"@theme-hope/components/transitions/index\";\nimport PasswordModal from \"@theme-hope/modules/encrypt/components/PasswordModal\";\nimport { useGlobalEncrypt } from \"@theme-hope/modules/encrypt/composables/index\";\nimport { usePure } from \"@theme-hope/composables/index\";\nimport { RenderDefault } from \"vuepress-shared/client\";\n\nexport default defineComponent({\n  name: \"GlobalEncrypt\",\n\n  slots: Object as SlotsType<{\n    default: () => VNode[] | VNode | null;\n  }>,\n\n  setup(_props, { slots }) {\n    const { isDecrypted, isEncrypted, validate } = useGlobalEncrypt();\n    const isPure = usePure();\n\n    const isMounted = ref(false);\n\n    onMounted(() => {\n      isMounted.value = true;\n    });\n\n    return (): VNode =>\n      h(isPure.value ? RenderDefault : FadeSlideY, () =>\n        isEncrypted.value\n          ? isMounted.value\n            ? isDecrypted.value\n              ? slots.default()\n              : h(PasswordModal, { full: true, onVerify: validate })\n            : null\n          : slots.default(),\n      );\n  },\n});\n","import type { SlotsType, VNode } from \"vue\";\nimport { defineComponent, h, onMounted, ref } from \"vue\";\n\nimport PasswordModal from \"@theme-hope/modules/encrypt/components/PasswordModal\";\nimport { usePathEncrypt } from \"@theme-hope/modules/encrypt/composables/index\";\n\nexport default defineComponent({\n  name: \"LocalEncrypt\",\n\n  slots: Object as SlotsType<{\n    default: () => VNode[] | VNode | null;\n  }>,\n\n  setup(_props, { slots }) {\n    const { status, validate } = usePathEncrypt();\n\n    const isMounted = ref(false);\n\n    onMounted(() => {\n      isMounted.value = true;\n    });\n\n    return (): VNode[] | VNode | null => {\n      const { isEncrypted, isDecrypted } = status.value;\n\n      return isEncrypted\n        ? isMounted.value\n          ? isDecrypted\n            ? slots.default()\n            : h(PasswordModal, { full: true, onVerify: validate })\n          : null\n        : slots.default();\n    };\n  },\n});\n"],"names":["defineComponent","props","emit","frontmatter","usePageFrontmatter","themeLocale","useThemeLocaleData","password","ref","hasTried","remember","locale","computed","hintHandler","verify","nextTick","h","LockIcon","target","key","useEncryptData","themeData","useThemeData","STORAGE_KEY","useGlobalEncrypt","encryptData","localToken","useStorage","sessionToken","useSessionStorage","isEncrypted","global","admin","isDecrypted","hash","compareSync","inputToken","keep","isTokenMatched","token","usePathEncrypt","page","usePageData","getPathMatchedKeys","path","isPlainObject","keys","startsWith","a","b","getStatus","matchedKeys","config","hitKey","_props","slots","validate","isPure","usePure","isMounted","onMounted","RenderDefault","FadeSlideY","PasswordModal","status"],"mappings":"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"}
{"version":3,"file":"ArtPlayer.js","sources":["../../../src/client/utils/registerMse.ts","../../../src/client/components/ArtPlayer.ts"],"sourcesContent":["declare const DASHJS_INSTALLED: boolean;\ndeclare const HLS_JS_INSTALLED: boolean;\ndeclare const MPEGTS_JS_INSTALLED: boolean;\n\nexport const SUPPORTED_VIDEO_TYPES = [\"mp4\", \"mp3\", \"webm\", \"ogg\"];\n\nif (typeof DASHJS_INSTALLED !== \"undefined\" && DASHJS_INSTALLED)\n  SUPPORTED_VIDEO_TYPES.push(\"mpd\", \"dash\");\n\nif (typeof HLS_JS_INSTALLED !== \"undefined\" && HLS_JS_INSTALLED)\n  SUPPORTED_VIDEO_TYPES.push(\"m3u8\", \"hls\");\n\nif (typeof MPEGTS_JS_INSTALLED !== \"undefined\" && MPEGTS_JS_INSTALLED)\n  SUPPORTED_VIDEO_TYPES.push(\"ts\", \"flv\");\n\nexport const getTypeByUrl = (url: string): string =>\n  url?.split(\".\").pop() ?? \"\";\n\nexport const registerMseDash = async (\n  mediaElement: HTMLMediaElement,\n  src: string,\n  onDestroy: (destroy: () => void) => void,\n  autoPlay = false,\n  startTime = 0,\n): Promise<void> => {\n  if (typeof DASHJS_INSTALLED !== \"undefined\" && DASHJS_INSTALLED) {\n    const dashjs = (await import(/* webpackChunkName: \"dashjs\" */ \"dashjs\"))\n      .default;\n\n    if (dashjs.supportsMediaSource()) {\n      const dashPlayer = dashjs.MediaPlayer().create();\n\n      dashPlayer.initialize(mediaElement, src, autoPlay, startTime);\n\n      onDestroy(() => dashPlayer.destroy());\n    }\n  }\n};\n\nexport const registerMseFlv = async (\n  mediaElement: HTMLMediaElement,\n  src: string,\n  onDestroy: (destroy: () => void) => void,\n): Promise<void> => {\n  if (typeof MPEGTS_JS_INSTALLED !== \"undefined\" && MPEGTS_JS_INSTALLED) {\n    const mpegts = (\n      await import(\n        /* webpackChunkName: \"mpegts.js\" */ \"mpegts.js/dist/mpegts.js\"\n      )\n    ).default;\n\n    if (mpegts.isSupported()) {\n      const flvPlayer = mpegts.createPlayer({\n        type: \"flv\",\n        url: src,\n      });\n\n      flvPlayer.attachMediaElement(mediaElement);\n      flvPlayer.load();\n\n      onDestroy(() => flvPlayer.destroy());\n    }\n  }\n};\n\nexport const registerMseHls = async (\n  mediaElement: HTMLMediaElement,\n  src: string,\n  onDestroy: (destroy: () => void) => void,\n): Promise<void> => {\n  if (\n    mediaElement.canPlayType(\"application/x-mpegURL\") ||\n    mediaElement.canPlayType(\"application/vnd.apple.mpegURL\")\n  ) {\n    mediaElement.src = src;\n  } else if (typeof HLS_JS_INSTALLED !== \"undefined\" && HLS_JS_INSTALLED) {\n    const hls = (\n      await import(/* webpackChunkName: \"hls.js\" */ \"hls.js/dist/hls.min.js\")\n    ).default;\n\n    if (hls.isSupported()) {\n      const hlsInstance = new hls();\n\n      hlsInstance.attachMedia(mediaElement);\n      hlsInstance.on(hls.Events.MEDIA_ATTACHED, () => {\n        hlsInstance.loadSource(src);\n      });\n\n      onDestroy(() => hlsInstance.destroy());\n    }\n  }\n};\n","/* eslint-disable vue/no-unused-properties */\nimport { keys } from \"@vuepress/helper/client\";\nimport type Artplayer from \"artplayer\";\nimport type { Option as ArtPlayerInitOptions } from \"artplayer/types/option.js\";\nimport type { PropType, VNode } from \"vue\";\nimport { camelize, defineComponent, h, onMounted, onUnmounted, ref } from \"vue\";\nimport { usePageLang } from \"vuepress/client\";\nimport { LoadingIcon } from \"vuepress-shared/client\";\n\nimport type { ArtPlayerOptions } from \"../../shared/index.js\";\nimport { useSize } from \"../composables/index.js\";\nimport { getLink } from \"../utils/getLink.js\";\nimport {\n  SUPPORTED_VIDEO_TYPES,\n  getTypeByUrl,\n  registerMseDash,\n  registerMseFlv,\n  registerMseHls,\n} from \"../utils/registerMse.js\";\n\nimport \"../styles/art-player.scss\";\n\nconst BOOLEAN_TRUE_ATTRS = [\n  \"no-fullscreen\",\n  \"no-hotkey\",\n  \"no-playback-rate\",\n  \"no-setting\",\n  \"no-mutex\",\n  \"no-plays-inline\",\n] as const;\n\nconst BOOLEAN_FALSE_ATTRS = [\n  \"airplay\",\n  \"autoplay\",\n  \"aspect-ratio\",\n  \"auto-mini\",\n  \"auto-size\",\n  \"auto-orientation\",\n  \"auto-playback\",\n  \"fast-forward\",\n  \"flip\",\n  \"fullscreen-web\",\n  \"lock\",\n  \"loop\",\n  \"is-live\",\n  \"muted\",\n  \"mini-progress-bar\",\n  \"pip\",\n  \"screenshot\",\n  \"subtitle-offset\",\n] as const;\n\n// Note: This should be updated with https://github.com/zhw2590582/ArtPlayer/blob/master/packages/artplayer/src/i18n/index.js\nconst SUPPORTED_LANG_NAME = [\n  \"en\",\n  \"pl\",\n  \"cs\",\n  \"es\",\n  \"fa\",\n  \"fr\",\n  \"id\",\n  \"ru\",\n  \"tr\",\n];\nconst SUPPORTED_LANG_CODE = [\"zh-cn\", \"zh-tw\"];\n\ntype KebabCaseToCamelCase<\n  S extends string,\n  Cap extends boolean = false,\n> = S extends `${infer Head}-${infer Tail}`\n  ? `${Cap extends true ? Capitalize<Head> : Head}${KebabCaseToCamelCase<\n      Tail,\n      true\n    >}`\n  : Cap extends true\n    ? Capitalize<S>\n    : S;\n\ntype ArtPlayerBooleanOptionKey =\n  | (typeof BOOLEAN_TRUE_ATTRS extends readonly (infer T extends string)[]\n      ? T extends `no-${infer Key}`\n        ? KebabCaseToCamelCase<Key>\n        : never\n      : never)\n  | (typeof BOOLEAN_FALSE_ATTRS extends readonly (infer T extends string)[]\n      ? KebabCaseToCamelCase<T>\n      : never);\n\ndeclare const ART_PLAYER_OPTIONS: ArtPlayerOptions;\n\nconst getLang = (lang: string): string => {\n  const langCode = lang.toLowerCase();\n  const [langName] = langCode.split(\"-\");\n\n  return SUPPORTED_LANG_CODE.includes(langCode)\n    ? langCode\n    : SUPPORTED_LANG_NAME.includes(langName)\n      ? langName\n      : langName === \"zh\"\n        ? \"zh-cn\"\n        : \"en\";\n};\n\nexport default defineComponent({\n  name: \"ArtPlayer\",\n\n  inheritAttrs: false,\n\n  props: {\n    /**\n     * Video Source URL\n     *\n     * 视频源文件地址\n     */\n    src: {\n      type: String,\n      required: true,\n    },\n\n    /**\n     * Video Type\n     *\n     * 视频类型\n     */\n    type: {\n      type: String,\n      default: \"\",\n    },\n\n    /**\n     * Video poster\n     *\n     * 视频封面\n     */\n    poster: {\n      type: String,\n      default: \"\",\n    },\n\n    /**\n     * Video title\n     *\n     * 视频标题\n     */\n    title: {\n      type: String,\n      default: \"\",\n    },\n\n    /**\n     * Component width\n     *\n     * 组件宽度\n     */\n    width: {\n      type: [String, Number],\n      default: \"100%\",\n    },\n\n    /**\n     * Component height\n     *\n     * 组件高度\n     */\n    height: {\n      type: [String, Number],\n      default: undefined,\n    },\n\n    /**\n     * Component width / height ratio\n     *\n     * 组件长宽比\n     */\n    ratio: {\n      type: [String, Number],\n      default: 16 / 9,\n    },\n\n    /**\n     * ArtPlayer config\n     *\n     * ArtPlayer 配置\n     */\n    config: {\n      type: Object as PropType<Omit<ArtPlayerOptions, \"container\">>,\n      default: null,\n    },\n\n    /**\n     * Customize Artplayer\n     *\n     * 对 Artplayer 进行自定义\n     */\n    customPlayer: {\n      type: Function as PropType<\n        (\n          player: Artplayer,\n        ) => Artplayer | void | Promise<Artplayer> | Promise<void>\n      >,\n\n      default: (player: Artplayer) => player,\n    },\n  },\n\n  setup(props, { attrs }) {\n    const lang = usePageLang();\n    const { el, width, height, resize } = useSize<HTMLDivElement>(props, 0);\n\n    const loaded = ref(false);\n    let artPlayerInstance: Artplayer;\n\n    const getInitOptions = (): ArtPlayerInitOptions => {\n      const initOptions: ArtPlayerInitOptions = {\n        theme: \"#3eaf7c\",\n        ...ART_PLAYER_OPTIONS,\n        container: el.value!,\n        poster: props.poster,\n        url: getLink(props.src),\n        type: props.type || getTypeByUrl(props.src),\n        lang: getLang(lang.value),\n        ...props.config,\n        // This option must be set false to avoid problems\n        useSSR: false,\n      };\n\n      const attrsKeys = keys(attrs);\n\n      BOOLEAN_TRUE_ATTRS.forEach((config) => {\n        if (attrsKeys.includes(config))\n          initOptions[\n            camelize(config.replace(/^no-/, \"\")) as ArtPlayerBooleanOptionKey\n          ] = false;\n      });\n      BOOLEAN_FALSE_ATTRS.forEach((config) => {\n        if (attrsKeys.includes(config))\n          initOptions[camelize(config) as ArtPlayerBooleanOptionKey] = true;\n      });\n\n      // Auto config mse\n      if (initOptions.type) {\n        const customType = (initOptions.customType ??= {});\n\n        if (SUPPORTED_VIDEO_TYPES.includes(initOptions.type.toLowerCase()))\n          switch (initOptions.type.toLowerCase()) {\n            case \"m3u8\":\n            case \"hls\":\n              customType[initOptions.type] ??= (\n                video: HTMLVideoElement,\n                src: string,\n                player: Artplayer,\n              ): Promise<void> =>\n                registerMseHls(video, src, (destroy) => {\n                  player.on(\"destroy\", destroy);\n                });\n              break;\n\n            case \"flv\":\n            case \"ts\":\n              customType[initOptions.type] ??= (\n                video: HTMLVideoElement,\n                src: string,\n                player: Artplayer,\n              ): Promise<void> =>\n                registerMseFlv(video, src, (destroy) => {\n                  player.on(\"destroy\", destroy);\n                });\n              break;\n\n            case \"mpd\":\n            case \"dash\":\n              customType[initOptions.type] ??= (\n                video: HTMLVideoElement,\n                src: string,\n                player: Artplayer,\n              ): Promise<void> =>\n                registerMseDash(video, src, (destroy) => {\n                  player.on(\"destroy\", destroy);\n                });\n              break;\n\n            default:\n          }\n        else\n          console.warn(\n            `[components]: ArtPlayer does not support current file type ${initOptions.type}!`,\n          );\n      }\n\n      return initOptions;\n    };\n\n    onMounted(async () => {\n      const { default: Artplayer } = await import(\n        /* webpackChunkName: \"artplayer\" */ \"artplayer\"\n      );\n      const player = new Artplayer(getInitOptions());\n\n      artPlayerInstance = (await props.customPlayer(player)) || player;\n      loaded.value = true;\n      resize();\n    });\n\n    onUnmounted(() => {\n      artPlayerInstance?.destroy();\n    });\n\n    return (): (VNode | null)[] => [\n      h(\"div\", {\n        ref: el,\n        class: \"vp-artplayer\",\n        style: {\n          width: width.value,\n          height: height.value,\n        },\n      }),\n      loaded.value ? null : h(LoadingIcon),\n    ];\n  },\n});\n"],"names":["SUPPORTED_VIDEO_TYPES","getTypeByUrl","url","registerMseDash","mediaElement","src","onDestroy","autoPlay","startTime","dashjs","dashPlayer","registerMseFlv","mpegts","flvPlayer","registerMseHls","hls","hlsInstance","BOOLEAN_TRUE_ATTRS","BOOLEAN_FALSE_ATTRS","SUPPORTED_LANG_NAME","SUPPORTED_LANG_CODE","getLang","lang","langCode","langName","defineComponent","player","props","attrs","usePageLang","el","width","height","resize","useSize","loaded","ref","artPlayerInstance","getInitOptions","initOptions","getLink","attrsKeys","keys","config","camelize","customType","video","destroy","onMounted","Artplayer","onUnmounted","h","LoadingIcon"],"mappings":"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"}
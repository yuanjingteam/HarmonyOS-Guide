const k=(t,r)=>{const l=t.pos,s=t.src.charAt(l);if(r||s!=="!")return!1;const e=t.scanDelims(t.pos,!0);let{length:p}=e;if(p<2)return!1;if(p%2){const i=t.push("text","",0);i.content=s,p--}for(let i=0;i<p;i+=2){const n=t.push("text","",0);n.content=`${s}${s}`,(e.can_open||e.can_close)&&t.delimiters.push({marker:33,length:0,jump:i/2,token:t.tokens.length-1,end:-1,open:e.can_open,close:e.can_close})}return t.pos+=e.length,!0},a=(t,r,{tag:l,attrs:s})=>{let e;const p=[],i=r.length;for(let n=0;n<i;n++){const o=r[n];if(o.marker===33&&o.end!==-1){const c=r[o.end];e=t.tokens[o.token],e.type="spoiler_open",e.tag=l,e.nesting=1,e.markup="!!",e.attrs=s,e.content="",e=t.tokens[c.token],e.type="spoiler_close",e.tag=l,e.nesting=-1,e.markup="!!",e.content="",t.tokens[c.token-1].type==="text"&&t.tokens[c.token-1].content==="!"&&p.push(c.token-1)}}for(;p.length;){const n=p.pop();let o=n+1;for(;o<t.tokens.length&&t.tokens[o].type==="spoiler_close";)o++;o--,n!==o&&(e=t.tokens[o],t.tokens[o]=t.tokens[n],t.tokens[n]=e)}},g=(t,{tag:r="span",attrs:l=[["class","spoiler"],["tabindex","-1"]]}={})=>{t.inline.ruler.before("emphasis","spoiler",k),t.inline.ruler2.before("emphasis","spoiler",s=>{a(s,s.delimiters,{tag:r,attrs:l});for(const e of s.tokens_meta??[])e?.delimiters&&a(s,e.delimiters,{tag:r,attrs:l});return!0})};export{g as spoiler};
//# sourceMappingURL=index.js.map
